from buildbot.plugins import (
    changes,
    schedulers,
    steps,
    util,
    worker,
)


worker = worker.DockerLatentWorker(
    "worker",
    "pass",
    docker_host="unix://var/run/docker.sock",
    image="cjolowicz/buildbot-worker:1.8.0-alpine-x86_64",
    masterFQDN="localhost",
)

factory = util.BuildFactory([
    steps.Git(repourl="git://github.com/buildbot/hello-world.git", mode="incremental"),
    steps.ShellCommand(command=["trial", "hello"], env={"PYTHONPATH": "."}),
])

builder = util.BuilderConfig(
    name="runtests",
    workernames=["worker"],
    factory=factory,
)

poller = changes.GitPoller(
    "git://github.com/buildbot/hello-world.git",
    workdir="gitpoller-workdir", branch="master",
    pollInterval=300,
)

schedulers = [
    schedulers.SingleBranchScheduler(
        name="all",
        change_filter=util.ChangeFilter(branch="master"),
        treeStableTimer=None,
        builderNames=["runtests"]),
    schedulers.ForceScheduler(
        name="force",
        builderNames=["runtests"]),
]

BuildmasterConfig = {
    "workers": [worker],
    "protocols": {"pb": {"port": 9989}},
    "change_source": [poller],
    "schedulers": schedulers,
    "builders": [builder],
    "title": "Hello World CI",
    "titleURL": "https://buildbot.github.io/hello-world/",
    "buildbotURL": "http://localhost:8010/",
    "www": {
        "port": 8010,
        "plugins": {
            "waterfall_view": {},
            "console_view": {},
            "grid_view": {},
        },
        "logfileName": None,  # do not use a separate logfile
    },
    "db": {"db_url": "sqlite:///state.sqlite"},
}
