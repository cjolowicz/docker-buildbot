import os

from buildbot.plugins import schedulers, steps, util, worker


worker = worker.LocalWorker("worker")

factory = util.BuildFactory([
    steps.ShellCommand(command=["wget", "https://github.com/buildbot/hello-world/archive/master.tar.gz"]),
    steps.ShellCommand(command=["tar", "-zxf", "master.tar.gz"]),
    steps.ShellCommand(command=["trial", "hello"], env={"PYTHONPATH": "."}, workdir="build/hello-world-master"),
])

builder = util.BuilderConfig(
    name="hello-world",
    workernames=["worker"],
    factory=factory,
)

scheduler = schedulers.ForceScheduler(
    name="trigger",
    builderNames=["hello-world"]
)

BuildmasterConfig = {
    "workers": [worker],
    "protocols": {"pb": {"port": 9989}},
    "schedulers": [scheduler],
    "builders": [builder],
    "title": "Hello World CI",
    "titleURL": "https://buildbot.github.io/hello-world/",
    "buildbotURL": os.environ.get("BUILDBOT_URL", "http://localhost:8010/"),
    "www": {
        "port": 8010,
        "plugins": {
            "waterfall_view": {},
            "console_view": {},
            "grid_view": {},
        },
    },
    "db": {"db_url": "sqlite:///state.sqlite"},
}
